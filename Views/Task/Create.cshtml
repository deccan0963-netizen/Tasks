@using TaskManagement.Models.Enums
@model TaskManagement.Models.TaskBo
@{
    ViewData["Title"] = "Create Task";
    var departments = ViewBag.Departments as List<ApiDeptDto> ?? new List<ApiDeptDto>();
    var users = ViewBag.Users as List<ApiUserDto> ?? new List<ApiUserDto>();
    //var projects = ViewBag.Projects as IEnumerable<dynamic> ?? new List<dynamic>();
     var projects = ViewBag.Projects as List<dynamic> ?? new List<dynamic>();
}

<!-- CSS -->
<link href="~/css/select2.min.css" rel="stylesheet" />
<link href="~/lib/bootstrap-datepicker-1.9.0-dist/css/bootstrap-datepicker.min.css" rel="stylesheet" />
<link rel="stylesheet" href="~/css/site.css" />

<style>
    .form-control,
    .form-select,
    .select2-container .select2-selection--single,
    .select2-container .select2-selection--multiple {
        height: 40px !important;
        min-height: 40px !important;
        border-radius: 6px !important;
        border: 1px solid #c5d9f0 !important;
        font-size: 0.95rem;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 40px !important;
    }

    .select2-container--default .select2-selection--multiple {
        min-height: 40px !important;
        height: auto !important;
        display: flex;
        align-items: center;
        padding: 2px 4px;
    }

    .custom-form-card {
        border: 1px solid #c5d9f0 !important;
        border-radius: 8px;
    }

    .custom-form-card .card-body {
        padding: 2rem;
    }

    .back-arrow i {
        color: #2a5298 !important;
        font-size: 1.5rem;
    }

    .back-arrow:hover i {
        color: #1e3c72 !important;
    }

    .back-arrow {
        display: inline-flex;
        align-items: center;
        padding: 5px;
        border-radius: 50%;
        transition: background 0.3s ease;
    }

    .back-arrow:hover {
        background: rgba(30, 60, 114, 0.1);
    }

    label {
        color: #1e3c72 !important;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }

    .form-control:focus,
    .form-select:focus,
    .select2-container--default.select2-container--focus .select2-selection {
        border-color: #2a5298 !important;
        box-shadow: 0 0 0 0.2rem rgba(42, 82, 152, 0.25) !important;
    }

    .select2-container--default .select2-selection--multiple .select2-selection__choice {
        background-color: #2a5298 !important;
        border-color: #2a5298 !important;
        color: white;
    }

    .btn-primary {
        background-color: #2a5298 !important;
        border-color: #2a5298 !important;
        color: #fff !important;
        font-weight: 500;
        padding: 0.5rem 2rem;
        transition: 0.3s;
    }

    .btn-primary:hover {
        background-color: #1e3c72 !important;
        border-color: #1e3c72 !important;
        transform: translateY(-2px);
    }

    h4 {
        color: #1e3c72 !important;
        font-weight: 600;
    }

    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
</style>

<div class="container mt-4">
    <div class="card custom-form-card shadow-sm w-100" style="max-width:1200px;">
        <div class="card-body">
            <div class="d-flex align-items-center mb-4">
                <a asp-action="Index" class="me-2 text-decoration-none back-arrow">
                    <i class="bi bi-arrow-left-circle fa-lg"></i>
                </a>
                <h4 class="fw-bold mb-0">Create Task</h4>
            </div>

            @Html.AntiForgeryToken()
            <form id="taskForm">
                <input asp-for="Id" type="hidden" />

                <div class="row g-3">
                    <!-- Task Name -->
                    <div class="col-md-3">
                        <label asp-for="TaskName"></label>
                        <input asp-for="TaskName" class="form-control" required />
                        <span asp-validation-for="TaskName" class="text-danger"></span>
                    </div>

                    <!-- Department -->
                    <div class="col-md-3">
                        <label asp-for="Department"></label>
                        <select asp-for="Department" id="Department" class="form-select select2" required>
                            <option value="">-- Select Department --</option>
                            @foreach (var dept in departments)
                            {
                                <option value="@dept.SectionId">@dept.SectionName</option>
                            }
                        </select>
                        <span asp-validation-for="Department" class="text-danger"></span>
                    </div>

                    <!-- Project -->
                    <div class="col-md-3">
                        <label>Work Segment</label>
                      <select asp-for="ProjectId" class="form-select select2" asp-items="Html.GetEnumSelectList<ProjectEnum>()">
                    <option value="">-- Select Project --</option>
                </select>
                        <span class="text-danger" id="ProjectId-validation"></span>
                    </div>
                    <div class="col-md-3">
    <label>Assigned By</label>
    <select id="AssignedBy" name="AssignedBy" class="form-select select2" required>
        <option value="">-- Select Assigned By --</option>
        @foreach (var user in users)
        {
            <option value="@user.userName">@user.userName</option>
        }
    </select>
    <span class="text-danger" id="AssignedBy-validation"></span>
</div>

                    <!-- Assigned Users -->
                    <div class="col-md-3">
                        <label>Assign User</label>
                        <select id="AssignedUsers" name="SelectedUserNames" class="form-select select2" multiple="multiple">
                            @foreach (var user in users)
                            {
                                <option value="@user.userName">@user.userName</option>
                            }
                        </select>
                        <span class="text-danger" id="AssignedUsers-validation"></span>
                    </div>

                    <!-- Due Date -->
                    <div class="col-md-3">
                        <label>Due Date</label>
                        <input type="text" id="DueDate" name="DueDate" class="form-control datepicker" placeholder="DD/MM/YYYY" required />
                        <span class="text-danger" id="DueDate-validation"></span>
                    </div>

                    <!-- Status -->
                    <div class="col-md-3">
                        <label>Status</label>
                        <select id="Status" name="Status" class="form-select select2">
                            <option value="0">Active</option>
                            <option value="1">Pending</option>
                            <option value="2">InProgress</option>
                            <option value="3">Completed</option>
                        </select>
                    </div>

                    <!-- Description -->
                    <div class="col-md-12">
                        <label asp-for="Description"></label>
                        <textarea asp-for="Description" class="form-control" rows="3" placeholder="Enter task description..."></textarea>
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary px-4">Save Task</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JS -->
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/bootstrap-datepicker-1.9.0-dist/js/bootstrap-datepicker.js"></script>
<script src="~/js/select2.min.js"></script>
<script src="~/js/sweetalert2.all.min.js"></script>
<script src="~/js/moment.min.js"></script>

<script>
    $(document).ready(function () {
        $(".select2").select2({ width: '100%' });
        $(".datepicker").datepicker({ format: 'dd/mm/yyyy', autoclose: true, todayHighlight: true });

        // ✅ Filter projects by department
        $('#Department').change(function () {
            var dept = $(this).val();
            $('#ProjectId option').each(function () {
                var projectDept = $(this).data('department');
                if (!dept || $(this).val() === "" || projectDept == dept) $(this).show();
                else $(this).hide();
            });
            $('#ProjectId').val('').trigger('change');
            $('#AssignedUsers').val(null).trigger('change');
        });

        // ✅ When selecting project → show ALL users
        $('#ProjectId').change(function () {
            var projectId = $(this).val();
            console.log("Project changed:", projectId);
            $('#AssignedUsers').empty();

            if (projectId) {
                // Load all users from ViewBag (in Razor)
                @foreach (var user in users)
                {
                    @:$('#AssignedUsers').append(new Option('@user.userName', '@user.userName'));
                }
            }

            $('#AssignedUsers').trigger('change');
        });

        // ✅ Submit form with validation
        $('#taskForm').submit(function (e) {
            e.preventDefault();

            var isValid = true;
            if (!$('#TaskName').val().trim()) isValid = false;
            if (!$('#Department').val()) isValid = false;
            if (!$('#ProjectId').val()) isValid = false;
            if (!$('#DueDate').val()) isValid = false;
            if (!$('#AssignedBy').val()) isValid = false;


            if (!isValid) {
                Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please fill all required fields.' });
                return;
            }

            var formData = {
                TaskName: $('#TaskName').val().trim(),
                Department: $('#Department').val(),
                ProjectId: $('#ProjectId').val(),
                   AssignedBy: $('#AssignedBy').val(),
                SelectedUserNames: $('#AssignedUsers').val() || [],
                DueDate: moment($('#DueDate').val(), 'DD/MM/YYYY').utc().format(),
                Description: $('#Description').val(),
                Status: $('#Status').val() || 0
            };

            Swal.fire({ title: 'Creating Task...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            $.ajax({
                url: '@Url.Action("Create", "Task")',
                type: 'POST',
                data: formData,
                headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },
                success: function (res) {
                    Swal.close();
                    if (res.success) {
                        Swal.fire({ icon: 'success', title: 'Task Created', timer: 2000, showConfirmButton: false })
                            .then(() => window.location.href = '@Url.Action("Index", "Task")');
                    } else {
                        Swal.fire({ icon: 'error', title: 'Error', text: res.errors?.join(', ') || 'Failed to create task' });
                    }
                },
                error: function () {
                    Swal.close();
                    Swal.fire({ icon: 'error', title: 'Error', text: 'Something went wrong.' });
                }
            });
        });
    });
</script>
